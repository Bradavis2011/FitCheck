generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  username  String?  @unique
  bio       String?
  passwordHash String?  @map("password_hash") // Optional: null for Clerk users
  profileImageUrl String? @map("profile_image_url")
  isPublic  Boolean  @default(false) @map("is_public")

  // Preferences
  stylePreferences Json? @default("{}") @map("style_preferences")
  bodyType         String? @map("body_type")
  colorSeason      String? @map("color_season")
  height           String? // "petite", "average", "tall"
  lifestyle        String[] @default([]) // ["Student", "Office worker", "Creative professional", etc.]
  fashionGoals     String[] @default([]) @map("fashion_goals") // ["Look professional", "Express creativity", etc.]
  fitPreference    String? @map("fit_preference") // "relaxed", "fitted", "balanced"
  budgetLevel      String? @map("budget_level") // "budget", "mid-range", "investment"

  // Privacy Settings
  privacySettings Json? @default("{\"blurFaceDefault\":true,\"visibility\":\"all\",\"autoDelete\":\"never\"}") @map("privacy_settings")
  // privacySettings fields: { blurFaceDefault: boolean, visibility: "all"|"followers"|"trusted", autoDelete: "never"|"24h"|"7d"|"30d" }

  // Subscription
  tier                  String   @default("free") // free, plus, pro
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  revenuecatId          String?  @unique @map("revenuecat_id")
  subscriptionProductId String?  @map("subscription_product_id")
  subscriptionStore     String?  @map("subscription_store")

  // Usage tracking
  dailyChecksUsed   Int      @default(0) @map("daily_checks_used")
  dailyChecksResetAt DateTime @default(now()) @map("daily_checks_reset_at") @db.Date

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  outfitChecks OutfitCheck[]
  userStats    UserStats?
  communityFeedbackGiven CommunityFeedback[] @relation("UserFeedbackGiven")
  reports      Report[]
  blockedUsers BlockedUser[]  @relation("UserBlocks")
  blockedBy    BlockedUser[]  @relation("UserBlockedBy")
  followers        Follow[]            @relation("UserFollowers")
  following        Follow[]            @relation("UserFollowing")
  notifications    Notification[]      @relation("UserNotifications")
  pushTokens       PushToken[]         @relation("UserPushTokens")
  hostedSessions   LiveSession[]       @relation("UserLiveSessions")
  liveChatMessages LiveChatMessage[]   @relation("UserLiveChatMessages")
  liveSessionViews LiveSessionViewer[] @relation("UserLiveSessionViews")
  subscriptionEvents SubscriptionEvent[]
  comparisonPosts    ComparisonPost[]   @relation("UserComparisonPosts")
  comparisonVotes    ComparisonVote[]   @relation("UserComparisonVotes")
  innerCircle         InnerCircleMember[] @relation("UserInnerCircle")
  innerCircleMemberOf InnerCircleMember[] @relation("InnerCircleMemberOf")
  stylistProfile     Stylist?
  expertReviewsRequested ExpertReview[] @relation("UserExpertReviews")
  challengeSubmissions   ChallengeSubmission[]
  challengeVotes         ChallengeVote[]
  wardrobeItems          WardrobeItem[]
  events                 Event[]
  eventOutfits           EventOutfit[]

  @@map("users")
}

model OutfitCheck {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Image data
  imageUrl  String? @map("image_url")
  imageData String? @db.Text
  thumbnailUrl String? @map("thumbnail_url")
  thumbnailData String? @db.Text @map("thumbnail_data")
  imageType String @default("photo") @map("image_type") // photo, video
  blurFace  Boolean @default(false) @map("blur_face") // Whether face is blurred in this outfit

  // Context provided by user
  occasions        String[]
  setting          String?
  weather          String?
  vibe             String?
  specificConcerns String? @map("specific_concerns")

  // AI Feedback
  aiFeedback     Json?     @map("ai_feedback")
  aiScore        Float?    @map("ai_score")
  aiProcessedAt  DateTime? @map("ai_processed_at")

  // User rating of feedback
  feedbackHelpful Boolean? @map("feedback_helpful")
  feedbackRating  Int?     @map("feedback_rating") // 1-5

  // Community scores (cached)
  communityAvgScore   Float? @map("community_avg_score")
  communityScoreCount Int    @default(0) @map("community_score_count")

  // Metadata
  isFavorite Boolean @default(false) @map("is_favorite")
  isDeleted  Boolean @default(false) @map("is_deleted")
  isPublic   Boolean @default(false) @map("is_public")
  visibility String  @default("all") // "all", "followers", "trusted" - who can see when public
  expiresAt  DateTime? @map("expires_at") // Auto-delete timestamp based on user's autoDelete setting

  createdAt DateTime @default(now()) @map("created_at")

  followUps FollowUp[]
  communityFeedback CommunityFeedback[]
  styleDNA StyleDNA?
  expertReviews ExpertReview[]
  challengeSubmissions ChallengeSubmission[]
  eventOutfits         EventOutfit[]

  @@map("outfit_checks")
}

model FollowUp {
  id            String      @id @default(uuid())
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)

  userQuestion String @map("user_question")
  aiResponse   String? @map("ai_response")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("follow_ups")
}

model UserStats {
  userId String @id @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Core Stats
  totalFeedbackGiven Int @default(0) @map("total_feedback_given")
  totalHelpfulVotes  Int @default(0) @map("total_helpful_votes")

  // Gamification
  points             Int @default(0)
  level              Int @default(1)
  xpToNextLevel      Int @default(100) @map("xp_to_next_level")

  // Streaks
  currentStreak      Int @default(0) @map("current_streak")
  longestStreak      Int @default(0) @map("longest_streak")
  lastActiveDate     DateTime? @map("last_active_date") @db.Date
  streakFreezeUsed   Boolean @default(false) @map("streak_freeze_used") // Resets weekly

  // Leaderboards
  weeklyPoints       Int @default(0) @map("weekly_points")
  monthlyPoints      Int @default(0) @map("monthly_points")
  lastWeeklyReset    DateTime @default(now()) @map("last_weekly_reset")
  lastMonthlyReset   DateTime @default(now()) @map("last_monthly_reset")

  // Badges
  badges             String[] @default([]) // Array of badge IDs like ["early_bird", "streak_master"]

  // Daily Goals
  dailyFeedbackCount Int @default(0) @map("daily_feedback_count")
  dailyHelpfulVotes  Int @default(0) @map("daily_helpful_votes")
  dailyGoalsResetAt  DateTime @default(now()) @map("daily_goals_reset_at") @db.Date

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_stats")
  @@index([weeklyPoints(sort: Desc)])
  @@index([monthlyPoints(sort: Desc)])
  @@index([points(sort: Desc)])
}

model CommunityFeedback {
  id        String      @id @default(uuid())
  outfitId  String      @map("outfit_id")
  outfit    OutfitCheck @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  userId    String      @map("user_id")
  user      User        @relation("UserFeedbackGiven", fields: [userId], references: [id], onDelete: Cascade)
  score     Int
  comment   String
  createdAt DateTime    @default(now()) @map("created_at")

  @@unique([outfitId, userId])
  @@map("community_feedback")
}

model Report {
  id         String   @id @default(uuid())
  reporterId String   @map("reporter_id")
  reporter   User     @relation(fields: [reporterId], references: [id])
  targetType String   @map("target_type") // "outfit" or "user"
  targetId   String   @map("target_id")
  reason     String   // "inappropriate", "spam", "other"
  details    String?
  status     String   @default("pending") // "pending", "reviewed", "resolved"
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("reports")
}

model BlockedUser {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserBlocks", fields: [userId], references: [id], onDelete: Cascade)
  blockedId String   @map("blocked_id")
  blocked   User     @relation("UserBlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, blockedId])
  @@map("blocked_users")
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String   @map("following_id")
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([followerId, followingId])
  @@map("follows")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "feedback", "follow", "milestone", "live"
  title     String
  body      String
  linkType  String?  @map("link_type") // "outfit", "user", "live_session"
  linkId    String?  @map("link_id")
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
  @@index([userId, createdAt])
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserPushTokens", fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  platform  String   // "ios" or "android"
  createdAt DateTime @default(now()) @map("created_at")

  @@map("push_tokens")
  @@index([userId])
}

model LiveSession {
  id            String    @id @default(uuid())
  hostId        String    @map("host_id")
  host          User      @relation("UserLiveSessions", fields: [hostId], references: [id], onDelete: Cascade)
  title         String
  status        String    @default("waiting") // "waiting", "live", "ended"
  livekitRoom   String?   @map("livekit_room")
  aiAnalysisId  String?   @map("ai_analysis_id")
  aiAnalyzedAt  DateTime? @map("ai_analyzed_at")
  peakViewers   Int       @default(0) @map("peak_viewers")
  totalViewers  Int       @default(0) @map("total_viewers")
  startedAt     DateTime? @map("started_at")
  endedAt       DateTime? @map("ended_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  chatMessages  LiveChatMessage[]
  viewers       LiveSessionViewer[]

  @@map("live_sessions")
  @@index([hostId, status])
  @@index([status, startedAt])
}

model LiveChatMessage {
  id          String      @id @default(uuid())
  sessionId   String      @map("session_id")
  session     LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId      String?     @map("user_id")
  user        User?       @relation("UserLiveChatMessages", fields: [userId], references: [id], onDelete: SetNull)
  isAi        Boolean     @default(false) @map("is_ai")
  messageType String      @default("text") @map("message_type") // "text", "ai_feedback", "system"
  content     String      @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")

  @@map("live_chat_messages")
  @@index([sessionId, createdAt])
}

model LiveSessionViewer {
  id        String      @id @default(uuid())
  sessionId String      @map("session_id")
  session   LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String      @map("user_id")
  user      User        @relation("UserLiveSessionViews", fields: [userId], references: [id], onDelete: Cascade)
  joinedAt  DateTime    @default(now()) @map("joined_at")
  leftAt    DateTime?   @map("left_at")

  @@unique([sessionId, userId])
  @@map("live_session_viewers")
  @@index([sessionId])
  @@index([userId])
}

model StyleDNA {
  id             String   @id @default(uuid())
  outfitCheckId  String   @unique @map("outfit_check_id")
  outfitCheck    OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId         String   @map("user_id")

  // Colors extracted from image
  dominantColors String[] @map("dominant_colors")   // ["navy", "white", "tan"]
  colorHarmony   String?  @map("color_harmony")     // "complementary", "analogous", "monochromatic", "neutral"
  colorCount     Int?     @map("color_count")

  // Style classification
  formalityLevel Int?     @map("formality_level")    // 1-5 (1=very casual, 5=black tie)
  styleArchetypes String[] @map("style_archetypes")  // ["minimalist", "classic", "streetwear"]
  silhouetteType String?  @map("silhouette_type")    // "fitted", "relaxed", "layered", "structured"

  // Garments detected
  garments       String[]                             // ["blazer", "chinos", "sneakers", "watch"]
  patterns       String[]                             // ["solid", "striped", "plaid"]
  textures       String[]                             // ["denim", "cotton", "leather", "knit"]

  // Scores (from AI analysis)
  colorScore       Float? @map("color_score")         // 1-10
  proportionScore  Float? @map("proportion_score")    // 1-10
  fitScore         Float? @map("fit_score")           // 1-10
  coherenceScore   Float? @map("coherence_score")     // 1-10

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@map("style_dna")
}

model CalibrationSnapshot {
  id           String   @id @default(uuid())
  period       String   // "2026-02-W07", "2026-02"
  sampleSize   Int      @map("sample_size")
  avgAiScore   Float    @map("avg_ai_score")
  avgCommunity Float    @map("avg_community_score")
  delta        Float    // avgAiScore - avgCommunity (positive = AI scores higher)
  correlation  Float?   // Pearson correlation coefficient
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([period])
  @@map("calibration_snapshots")
}

model ComparisonPost {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation("UserComparisonPosts", fields: [userId], references: [id], onDelete: Cascade)

  // Both outfit images
  imageAUrl  String?  @db.Text @map("image_a_url")
  imageAData String?  @db.Text @map("image_a_data")
  imageBUrl  String?  @db.Text @map("image_b_url")
  imageBData String?  @db.Text @map("image_b_data")

  question   String?
  occasions  String[]

  // Cached vote counts
  votesA     Int      @default(0) @map("votes_a")
  votesB     Int      @default(0) @map("votes_b")

  isDeleted  Boolean  @default(false) @map("is_deleted")
  createdAt  DateTime @default(now()) @map("created_at")

  votes      ComparisonVote[]

  @@map("comparison_posts")
  @@index([userId, createdAt])
  @@index([createdAt])
}

model ComparisonVote {
  id        String         @id @default(uuid())
  postId    String         @map("post_id")
  post      ComparisonPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String         @map("user_id")
  user      User           @relation("UserComparisonVotes", fields: [userId], references: [id], onDelete: Cascade)
  choice    String         // "A" or "B"
  createdAt DateTime       @default(now()) @map("created_at")

  @@unique([postId, userId])
  @@map("comparison_votes")
  @@index([postId])
  @@index([userId])
}

model InnerCircleMember {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserInnerCircle", fields: [userId], references: [id], onDelete: Cascade)
  memberId  String   @map("member_id")
  member    User     @relation("InnerCircleMemberOf", fields: [memberId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, memberId])
  @@map("inner_circle_members")
  @@index([userId])
  @@index([memberId])
}

model Stylist {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio          String?
  specialties  String[] @default([]) // ["streetwear", "formal", "casual", "minimalist"]
  instagramUrl String?  @map("instagram_url")
  verified     Boolean  @default(false)
  rating       Float    @default(0)
  reviewCount  Int      @default(0) @map("review_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  reviews      ExpertReview[]

  @@map("stylists")
}

model ExpertReview {
  id            String      @id @default(uuid())
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  user          User        @relation("UserExpertReviews", fields: [userId], references: [id], onDelete: Cascade)
  stylistId     String      @map("stylist_id")
  stylist       Stylist     @relation(fields: [stylistId], references: [id], onDelete: Cascade)

  status        String    @default("pending") // "pending", "in_progress", "completed", "cancelled"
  score         Int?
  feedback      String?   @db.Text
  completedAt   DateTime? @map("completed_at")
  requestedAt   DateTime  @default(now()) @map("requested_at")

  @@index([userId, requestedAt])
  @@index([stylistId, status])
  @@index([outfitCheckId])
  @@map("expert_reviews")
}

model Event {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  date      DateTime
  dressCode String?  @map("dress_code") // "casual", "smart_casual", "business_casual", "formal", "black_tie"
  type      String?  // "wedding", "job_interview", "date_night", "conference", "party", "vacation", "other"
  notes     String?  @db.Text
  status    String   @default("upcoming") // "upcoming", "past"
  // Cached AI comparison result
  compareResult Json? @map("compare_result")
  compareRunAt  DateTime? @map("compare_run_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  outfitOptions EventOutfit[]

  @@map("events")
  @@index([userId, date])
  @@index([userId, status])
}

model EventOutfit {
  id            String      @id @default(uuid())
  eventId       String      @map("event_id")
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedAt       DateTime    @default(now()) @map("added_at")

  @@unique([eventId, outfitCheckId])
  @@map("event_outfits")
  @@index([eventId])
  @@index([userId])
}

model WardrobeItem {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  category  String    // "tops" | "bottoms" | "shoes" | "accessories" | "outerwear"
  color     String?
  imageUrl  String?   @db.Text @map("image_url")
  timesWorn Int       @default(0) @map("times_worn")
  lastWorn  DateTime? @map("last_worn")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("wardrobe_items")
  @@index([userId, category])
  @@index([userId, timesWorn(sort: Desc)])
}

model Challenge {
  id          String   @id @default(uuid())
  title       String
  description String
  theme       String
  prize       String?
  status      String   @default("upcoming") // "upcoming", "active", "ended"
  startsAt    DateTime @map("starts_at")
  endsAt      DateTime @map("ends_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  submissions ChallengeSubmission[]

  @@map("challenges")
  @@index([status, startsAt])
  @@index([status, endsAt])
}

model ChallengeSubmission {
  id            String      @id @default(uuid())
  challengeId   String      @map("challenge_id")
  challenge     Challenge   @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes         Int         @default(0)
  createdAt     DateTime    @default(now()) @map("created_at")

  voters ChallengeVote[]

  @@unique([challengeId, userId])
  @@unique([challengeId, outfitCheckId])
  @@map("challenge_submissions")
  @@index([challengeId, votes(sort: Desc)])
  @@index([userId])
}

model ChallengeVote {
  id           String              @id @default(uuid())
  submissionId String              @map("submission_id")
  submission   ChallengeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  userId       String              @map("user_id")
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime            @default(now()) @map("created_at")

  @@unique([submissionId, userId])
  @@map("challenge_votes")
  @@index([submissionId])
  @@index([userId])
}

model SubscriptionEvent {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventType      String   @map("event_type")
  productId      String?  @map("product_id")
  entitlementIds String[] @map("entitlement_ids")
  store          String?
  environment    String?

  rawPayload     Json?    @map("raw_payload")

  processedAt    DateTime @default(now()) @map("processed_at")

  @@map("subscription_events")
  @@index([userId, processedAt])
}
