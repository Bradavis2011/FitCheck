generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  username  String?  @unique
  bio       String?
  passwordHash String?  @map("password_hash") // Optional: null for Clerk users
  profileImageUrl String? @map("profile_image_url")
  isPublic  Boolean  @default(false) @map("is_public")

  // Preferences
  stylePreferences Json? @default("{}") @map("style_preferences")
  bodyType         String? @map("body_type")
  colorSeason      String? @map("color_season")
  height           String? // "petite", "average", "tall"
  lifestyle        String[] @default([]) // ["Student", "Office worker", "Creative professional", etc.]
  fashionGoals     String[] @default([]) @map("fashion_goals") // ["Look professional", "Express creativity", etc.]
  fitPreference    String? @map("fit_preference") // "relaxed", "fitted", "balanced"
  budgetLevel      String? @map("budget_level") // "budget", "mid-range", "investment"

  // Privacy Settings
  privacySettings Json? @default("{\"blurFaceDefault\":true,\"visibility\":\"all\",\"autoDelete\":\"never\"}") @map("privacy_settings")
  // privacySettings fields: { blurFaceDefault: boolean, visibility: "all"|"followers"|"trusted", autoDelete: "never"|"24h"|"7d"|"30d" }

  // Subscription
  tier                  String   @default("free") // free, plus, pro
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  revenuecatId          String?  @unique @map("revenuecat_id")
  subscriptionProductId String?  @map("subscription_product_id")
  subscriptionStore     String?  @map("subscription_store")

  // Usage tracking
  dailyChecksUsed   Int      @default(0) @map("daily_checks_used")
  dailyChecksResetAt DateTime @default(now()) @map("daily_checks_reset_at") @db.Date

  // Nudge personalization
  preferredNudgeHour Int?    @map("preferred_nudge_hour") // UTC hour with most outfit check activity (0-23)

  // Referral system
  referralCode      String?  @unique @map("referral_code")
  referredById      String?  @map("referred_by_id")
  referredBy        User?    @relation("UserReferrals", fields: [referredById], references: [id], onDelete: SetNull)
  referredUsers     User[]   @relation("UserReferrals")
  bonusDailyChecks  Int      @default(0) @map("bonus_daily_checks")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  outfitChecks OutfitCheck[]
  userStats    UserStats?
  communityFeedbackGiven CommunityFeedback[] @relation("UserFeedbackGiven")
  reports      Report[]
  blockedUsers BlockedUser[]  @relation("UserBlocks")
  blockedBy    BlockedUser[]  @relation("UserBlockedBy")
  followers        Follow[]            @relation("UserFollowers")
  following        Follow[]            @relation("UserFollowing")
  notifications    Notification[]      @relation("UserNotifications")
  pushTokens       PushToken[]         @relation("UserPushTokens")
  hostedSessions   LiveSession[]       @relation("UserLiveSessions")
  liveChatMessages LiveChatMessage[]   @relation("UserLiveChatMessages")
  liveSessionViews LiveSessionViewer[] @relation("UserLiveSessionViews")
  subscriptionEvents SubscriptionEvent[]
  comparisonPosts    ComparisonPost[]   @relation("UserComparisonPosts")
  comparisonVotes    ComparisonVote[]   @relation("UserComparisonVotes")
  innerCircle         InnerCircleMember[] @relation("UserInnerCircle")
  innerCircleMemberOf InnerCircleMember[] @relation("InnerCircleMemberOf")
  stylistProfile     Stylist?
  expertReviewsRequested ExpertReview[] @relation("UserExpertReviews")
  challengeSubmissions   ChallengeSubmission[]
  challengeVotes         ChallengeVote[]
  wardrobeItems          WardrobeItem[]
  events                 Event[]
  eventOutfits           EventOutfit[]
  eventFollowUps         EventFollowUp[]
  styleNarratives        StyleNarrative[]
  milestoneMessages      MilestoneMessage[]

  @@map("users")
  @@index([tier])
}

model OutfitCheck {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Image data
  imageUrl  String? @map("image_url")
  imageData String? @db.Text
  thumbnailUrl String? @map("thumbnail_url")
  thumbnailData String? @db.Text @map("thumbnail_data")
  imageType String @default("photo") @map("image_type") // photo, video
  blurFace  Boolean @default(false) @map("blur_face") // Whether face is blurred in this outfit

  // Context provided by user
  occasions        String[]
  setting          String?
  weather          String?
  vibe             String?
  specificConcerns String? @map("specific_concerns")
  eventDate        DateTime? @map("event_date")

  // AI Feedback
  aiFeedback     Json?     @map("ai_feedback")
  aiScore        Float?    @map("ai_score")
  aiProcessedAt  DateTime? @map("ai_processed_at")
  promptVersion  String?   @map("prompt_version")

  // User rating of feedback
  feedbackHelpful Boolean? @map("feedback_helpful")
  feedbackRating  Int?     @map("feedback_rating") // 1-5

  // Piggyback Judge scores (Self-Improving Engine)
  judgeScores     Json?    @map("judge_scores")
  judgeEvaluated  Boolean  @default(false) @map("judge_evaluated")

  // Community scores (cached)
  communityAvgScore   Float? @map("community_avg_score")
  communityScoreCount Int    @default(0) @map("community_score_count")

  // Metadata
  isFavorite Boolean @default(false) @map("is_favorite")
  isDeleted  Boolean @default(false) @map("is_deleted")
  isPublic   Boolean @default(false) @map("is_public")
  visibility String  @default("all") // "all", "followers", "trusted" - who can see when public
  expiresAt  DateTime? @map("expires_at") // Auto-delete timestamp based on user's autoDelete setting

  createdAt DateTime @default(now()) @map("created_at")

  followUps FollowUp[]
  communityFeedback CommunityFeedback[]
  styleDNA StyleDNA?
  expertReviews ExpertReview[]
  challengeSubmissions ChallengeSubmission[]
  eventOutfits         EventOutfit[]
  wardrobeLinks        WardrobeItemOutfit[]
  eventFollowUps       EventFollowUp[]

  @@map("outfit_checks")
  @@index([userId, createdAt])
  @@index([userId, isDeleted])
  @@index([isPublic, createdAt])
}

model FollowUp {
  id            String      @id @default(uuid())
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)

  userQuestion String @map("user_question")
  aiResponse   String? @map("ai_response")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("follow_ups")
  @@index([outfitCheckId])
}

model UserStats {
  userId String @id @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Core Stats
  totalFeedbackGiven Int @default(0) @map("total_feedback_given")
  totalHelpfulVotes  Int @default(0) @map("total_helpful_votes")

  // Gamification
  points             Int @default(0)
  level              Int @default(1)
  xpToNextLevel      Int @default(100) @map("xp_to_next_level")

  // Streaks
  currentStreak      Int @default(0) @map("current_streak")
  longestStreak      Int @default(0) @map("longest_streak")
  lastActiveDate     DateTime? @map("last_active_date") @db.Date
  streakFreezeUsed   Boolean @default(false) @map("streak_freeze_used") // Resets weekly

  // Leaderboards
  weeklyPoints       Int @default(0) @map("weekly_points")
  monthlyPoints      Int @default(0) @map("monthly_points")
  lastWeeklyReset    DateTime @default(now()) @map("last_weekly_reset")
  lastMonthlyReset   DateTime @default(now()) @map("last_monthly_reset")

  // Badges
  badges             String[] @default([]) // Array of badge IDs like ["early_bird", "streak_master"]

  // Daily Goals
  dailyFeedbackCount Int @default(0) @map("daily_feedback_count")
  dailyHelpfulVotes  Int @default(0) @map("daily_helpful_votes")
  dailyGoalsResetAt  DateTime @default(now()) @map("daily_goals_reset_at") @db.Date

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_stats")
  @@index([weeklyPoints(sort: Desc)])
  @@index([monthlyPoints(sort: Desc)])
  @@index([points(sort: Desc)])
}

model CommunityFeedback {
  id        String      @id @default(uuid())
  outfitId  String      @map("outfit_id")
  outfit    OutfitCheck @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  userId    String      @map("user_id")
  user      User        @relation("UserFeedbackGiven", fields: [userId], references: [id], onDelete: Cascade)
  score     Int
  comment   String
  createdAt DateTime    @default(now()) @map("created_at")

  @@unique([outfitId, userId])
  @@map("community_feedback")
}

model Report {
  id         String   @id @default(uuid())
  reporterId String   @map("reporter_id")
  reporter   User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  targetType String   @map("target_type") // "outfit" or "user"
  targetId   String   @map("target_id")
  reason     String   // "inappropriate", "spam", "other"
  details    String?
  status     String   @default("pending") // "pending", "reviewed", "resolved"
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("reports")
  @@index([status, createdAt])
}

model BlockedUser {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserBlocks", fields: [userId], references: [id], onDelete: Cascade)
  blockedId String   @map("blocked_id")
  blocked   User     @relation("UserBlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, blockedId])
  @@map("blocked_users")
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String   @map("following_id")
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([followerId, followingId])
  @@map("follows")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "feedback", "follow", "milestone", "live"
  title     String
  body      String
  linkType  String?  @map("link_type") // "outfit", "user", "live_session"
  linkId    String?  @map("link_id")
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
  @@index([userId, createdAt])
  @@index([userId, isRead])
  @@index([type, createdAt])
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserPushTokens", fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  platform  String   // "ios" or "android"
  createdAt DateTime @default(now()) @map("created_at")

  @@map("push_tokens")
  @@index([userId])
}

model LiveSession {
  id            String    @id @default(uuid())
  hostId        String    @map("host_id")
  host          User      @relation("UserLiveSessions", fields: [hostId], references: [id], onDelete: Cascade)
  title         String
  status        String    @default("waiting") // "waiting", "live", "ended"
  livekitRoom   String?   @map("livekit_room")
  aiAnalysisId  String?   @map("ai_analysis_id")
  aiAnalyzedAt  DateTime? @map("ai_analyzed_at")
  peakViewers   Int       @default(0) @map("peak_viewers")
  totalViewers  Int       @default(0) @map("total_viewers")
  startedAt     DateTime? @map("started_at")
  endedAt       DateTime? @map("ended_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  chatMessages  LiveChatMessage[]
  viewers       LiveSessionViewer[]

  @@map("live_sessions")
  @@index([hostId, status])
  @@index([status, startedAt])
}

model LiveChatMessage {
  id          String      @id @default(uuid())
  sessionId   String      @map("session_id")
  session     LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId      String?     @map("user_id")
  user        User?       @relation("UserLiveChatMessages", fields: [userId], references: [id], onDelete: SetNull)
  isAi        Boolean     @default(false) @map("is_ai")
  messageType String      @default("text") @map("message_type") // "text", "ai_feedback", "system"
  content     String      @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")

  @@map("live_chat_messages")
  @@index([sessionId, createdAt])
}

model LiveSessionViewer {
  id        String      @id @default(uuid())
  sessionId String      @map("session_id")
  session   LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String      @map("user_id")
  user      User        @relation("UserLiveSessionViews", fields: [userId], references: [id], onDelete: Cascade)
  joinedAt  DateTime    @default(now()) @map("joined_at")
  leftAt    DateTime?   @map("left_at")

  @@unique([sessionId, userId])
  @@map("live_session_viewers")
  @@index([sessionId])
  @@index([userId])
}

model StyleDNA {
  id             String   @id @default(uuid())
  outfitCheckId  String   @unique @map("outfit_check_id")
  outfitCheck    OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId         String   @map("user_id")

  // Colors extracted from image
  dominantColors String[] @map("dominant_colors")   // ["navy", "white", "tan"]
  colorHarmony   String?  @map("color_harmony")     // "complementary", "analogous", "monochromatic", "neutral"
  colorCount     Int?     @map("color_count")

  // Style classification
  formalityLevel Int?     @map("formality_level")    // 1-5 (1=very casual, 5=black tie)
  styleArchetypes String[] @map("style_archetypes")  // ["minimalist", "classic", "streetwear"]
  silhouetteType String?  @map("silhouette_type")    // "fitted", "relaxed", "layered", "structured"

  // Garments detected
  garments       String[]                             // ["blazer", "chinos", "sneakers", "watch"]
  patterns       String[]                             // ["solid", "striped", "plaid"]
  textures       String[]                             // ["denim", "cotton", "leather", "knit"]

  // Scores (from AI analysis)
  colorScore       Float? @map("color_score")         // 1-10
  proportionScore  Float? @map("proportion_score")    // 1-10
  fitScore         Float? @map("fit_score")           // 1-10
  coherenceScore   Float? @map("coherence_score")     // 1-10

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("style_dna")
}

model CalibrationSnapshot {
  id           String   @id @default(uuid())
  period       String   // "2026-02-W07", "2026-02"
  sampleSize   Int      @map("sample_size")
  avgAiScore   Float    @map("avg_ai_score")
  avgCommunity Float    @map("avg_community_score")
  delta        Float    // avgAiScore - avgCommunity (positive = AI scores higher)
  correlation  Float?   // Pearson correlation coefficient
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([period])
  @@map("calibration_snapshots")
}

model ComparisonPost {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation("UserComparisonPosts", fields: [userId], references: [id], onDelete: Cascade)

  // Both outfit images
  imageAUrl  String?  @db.Text @map("image_a_url")
  imageAData String?  @db.Text @map("image_a_data")
  imageBUrl  String?  @db.Text @map("image_b_url")
  imageBData String?  @db.Text @map("image_b_data")

  question   String?
  occasions  String[]

  // Cached vote counts
  votesA     Int      @default(0) @map("votes_a")
  votesB     Int      @default(0) @map("votes_b")

  // AI verdict (from analyzeComparison — stored for learning loop calibration)
  aiVerdict  String?  @map("ai_verdict") // "A" or "B"

  isDeleted  Boolean  @default(false) @map("is_deleted")
  createdAt  DateTime @default(now()) @map("created_at")

  votes      ComparisonVote[]

  @@map("comparison_posts")
  @@index([userId, createdAt])
  @@index([createdAt])
}

model ComparisonVote {
  id        String         @id @default(uuid())
  postId    String         @map("post_id")
  post      ComparisonPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String         @map("user_id")
  user      User           @relation("UserComparisonVotes", fields: [userId], references: [id], onDelete: Cascade)
  choice    String         // "A" or "B"
  createdAt DateTime       @default(now()) @map("created_at")

  @@unique([postId, userId])
  @@map("comparison_votes")
  @@index([postId])
  @@index([userId])
}

model InnerCircleMember {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation("UserInnerCircle", fields: [userId], references: [id], onDelete: Cascade)
  memberId  String   @map("member_id")
  member    User     @relation("InnerCircleMemberOf", fields: [memberId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, memberId])
  @@map("inner_circle_members")
  @@index([userId])
  @@index([memberId])
}

model Stylist {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio          String?
  specialties  String[] @default([]) // ["streetwear", "formal", "casual", "minimalist"]
  instagramUrl String?  @map("instagram_url")
  verified     Boolean  @default(false)
  rating       Float    @default(0)
  reviewCount  Int      @default(0) @map("review_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  reviews      ExpertReview[]

  @@map("stylists")
}

model ExpertReview {
  id            String      @id @default(uuid())
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  user          User        @relation("UserExpertReviews", fields: [userId], references: [id], onDelete: Cascade)
  stylistId     String      @map("stylist_id")
  stylist       Stylist     @relation(fields: [stylistId], references: [id], onDelete: Cascade)

  status        String    @default("pending") // "pending", "in_progress", "completed", "cancelled"
  score         Int?
  feedback      String?   @db.Text
  completedAt   DateTime? @map("completed_at")
  requestedAt   DateTime  @default(now()) @map("requested_at")

  @@index([userId, requestedAt])
  @@index([stylistId, status])
  @@index([outfitCheckId])
  @@map("expert_reviews")
}

model Event {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  date      DateTime
  dressCode String?  @map("dress_code") // "casual", "smart_casual", "business_casual", "formal", "black_tie"
  type      String?  // "wedding", "job_interview", "date_night", "conference", "party", "vacation", "other"
  notes     String?  @db.Text
  status    String   @default("upcoming") // "upcoming", "past"
  // Cached AI comparison result
  compareResult Json? @map("compare_result")
  compareRunAt  DateTime? @map("compare_run_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  outfitOptions EventOutfit[]

  @@map("events")
  @@index([userId, date])
  @@index([userId, status])
}

model EventOutfit {
  id            String      @id @default(uuid())
  eventId       String      @map("event_id")
  event         Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedAt       DateTime    @default(now()) @map("added_at")

  @@unique([eventId, outfitCheckId])
  @@map("event_outfits")
  @@index([eventId])
  @@index([userId])
}

model WardrobeItem {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  category       String    // "tops" | "bottoms" | "shoes" | "accessories" | "outerwear"
  color          String?
  imageUrl       String?   @db.Text @map("image_url")
  timesWorn      Int       @default(0) @map("times_worn")
  lastWorn       DateTime? @map("last_worn")
  source         String    @default("manual") // "manual" | "ai-detected"
  normalizedName String?   @map("normalized_name")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  outfitLinks WardrobeItemOutfit[]

  @@map("wardrobe_items")
  @@index([userId, category])
  @@index([userId, timesWorn(sort: Desc)])
  @@index([userId, normalizedName])
}

model WardrobeItemOutfit {
  id              String      @id @default(uuid())
  wardrobeItemId  String      @map("wardrobe_item_id")
  wardrobeItem    WardrobeItem @relation(fields: [wardrobeItemId], references: [id], onDelete: Cascade)
  outfitCheckId   String      @map("outfit_check_id")
  outfitCheck     OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  detectedName    String      @map("detected_name")
  createdAt       DateTime    @default(now()) @map("created_at")

  @@unique([wardrobeItemId, outfitCheckId])
  @@map("wardrobe_item_outfits")
  @@index([wardrobeItemId])
  @@index([outfitCheckId])
}

model Challenge {
  id          String   @id @default(uuid())
  title       String
  description String
  theme       String
  prize       String?
  status      String   @default("upcoming") // "upcoming", "active", "ended"
  startsAt    DateTime @map("starts_at")
  endsAt      DateTime @map("ends_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  submissions ChallengeSubmission[]

  @@map("challenges")
  @@index([status, startsAt])
  @@index([status, endsAt])
}

model ChallengeSubmission {
  id            String      @id @default(uuid())
  challengeId   String      @map("challenge_id")
  challenge     Challenge   @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes         Int         @default(0)
  createdAt     DateTime    @default(now()) @map("created_at")

  voters ChallengeVote[]

  @@unique([challengeId, userId])
  @@unique([challengeId, outfitCheckId])
  @@map("challenge_submissions")
  @@index([challengeId, votes(sort: Desc)])
  @@index([userId])
}

model ChallengeVote {
  id           String              @id @default(uuid())
  submissionId String              @map("submission_id")
  submission   ChallengeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  userId       String              @map("user_id")
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime            @default(now()) @map("created_at")

  @@unique([submissionId, userId])
  @@map("challenge_votes")
  @@index([submissionId])
  @@index([userId])
}

model FashionTrend {
  id               String    @id @default(uuid())
  period           String    @unique  // "2026-W08"
  region           String    @default("global")
  seasonalColors   String[]  @map("seasonal_colors")
  trendingStyles   String[]  @map("trending_styles")
  keyPieces        String[]  @map("key_pieces")
  trendingPatterns String[]  @map("trending_patterns")
  fadingTrends     String[]  @map("fading_trends")
  rawAnalysis      Json?     @map("raw_analysis")
  platformTrends   Json?     @map("platform_trends")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@map("fashion_trends")
}

// ─── Autonomous Agent Workforce Models ───────────────────────────────────────

model AgentAction {
  id          String    @id @default(uuid())
  agent       String
  actionType  String    @map("action_type")
  riskLevel   String    @default("low") @map("risk_level")
  status      String    @default("pending") // "pending", "approved", "executed", "rejected", "failed"
  payload     Json
  result      Json?
  reviewedBy  String?   @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")
  executedAt  DateTime? @map("executed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("agent_actions")
  @@index([agent, status])
  @@index([status, createdAt])
  @@index([riskLevel, status])
}

model AgentConfig {
  id               String    @id @default(uuid())
  agent            String    @unique
  enabled          Boolean   @default(true)
  maxActionsPerDay Int       @default(50) @map("max_actions_per_day")
  maxActionsPerHour Int      @default(10) @map("max_actions_per_hour")
  autoApproveRisk  String    @default("medium") @map("auto_approve_risk") // max risk level to auto-approve
  config           Json      @default("{}")
  lastRunAt        DateTime? @map("last_run_at")
  lastError        String?   @map("last_error")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("agent_configs")
}

model EmailSequence {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  sequence    String    // "welcome", "onboarding", "reengagement", "upgrade", "churn_prevention"
  currentStep Int       @default(0) @map("current_step")
  status      String    @default("active") // "active", "completed", "cancelled", "paused"
  startedAt   DateTime  @default(now()) @map("started_at")
  nextSendAt  DateTime? @map("next_send_at")
  completedAt DateTime? @map("completed_at")

  @@map("email_sequences")
  @@unique([userId, sequence])
  @@index([userId])
  @@index([status, nextSendAt])
}

model EmailEvent {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  sequence String
  step     Int
  subject  String
  status   String   @default("sent") // "sent", "delivered", "opened", "clicked", "bounced"
  sentAt   DateTime @default(now()) @map("sent_at")

  @@map("email_events")
  @@index([userId, sequence])
}

model ConversionSignal {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  signalType  String    @map("signal_type") // "hit_daily_limit", "used_follow_up", "high_engagement", "loyal_free"
  strength    Float
  actedOn     Boolean   @default(false) @map("acted_on")
  convertedAt DateTime? @map("converted_at") // when user actually upgraded
  outcome     String?                         // "converted", "ignored", "pending"
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("conversion_signals")
  @@index([userId, actedOn])
  @@index([signalType, createdAt])
}

model SocialPost {
  id           String    @id @default(uuid())
  platform     String    // "twitter", "instagram", "tiktok"
  content      String    @db.Text
  mediaUrl     String?   @map("media_url")
  hashtags     String[]
  status       String    @default("draft") // "draft", "approved", "posted", "rejected"
  scheduledFor DateTime? @map("scheduled_for")
  postedAt     DateTime? @map("posted_at")
  externalId   String?   @map("external_id")
  engagement   Json?
  contentType  String?   @map("content_type")  // "founder_story" | "fashion_news" | "community_spotlight" | "style_data_drop" | "wardrobe_insight" | "conversation_starter" | "behind_the_scenes"
  sourceData   Json?     @map("source_data")   // Raw data that generated the post (commits, headlines, stats)
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("social_posts")
  @@index([status, scheduledFor])
  @@index([contentType, createdAt])
}

model AppReview {
  id          String    @id @default(uuid())
  store       String    // "apple", "google"
  externalId  String    @unique @map("external_id")
  rating      Int
  title       String?
  body        String?   @db.Text
  author      String?
  draftReply  String?   @db.Text @map("draft_reply")
  replyStatus String    @default("pending") @map("reply_status") // "pending", "approved", "posted", "skipped"
  postedAt    DateTime? @map("posted_at")
  reviewDate  DateTime  @map("review_date")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("app_reviews")
  @@index([store, replyStatus])
  @@index([rating, createdAt])
}

// ─── End Agent Workforce Models ───────────────────────────────────────────────

// ─── Relationship System Models ───────────────────────────────────────────────

model EventFollowUp {
  id            String      @id @default(uuid())
  outfitCheckId String      @map("outfit_check_id")
  outfitCheck   OutfitCheck @relation(fields: [outfitCheckId], references: [id], onDelete: Cascade)
  userId        String      @map("user_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  occasion      String
  eventDate     DateTime?   @map("event_date")
  followUpAt    DateTime    @map("follow_up_at")
  response      String?     // "crushed_it" | "felt_good" | "meh" | "not_great"
  respondedAt   DateTime?   @map("responded_at")
  pushSentAt    DateTime?   @map("push_sent_at")
  emailSentAt   DateTime?   @map("email_sent_at")
  status        String      @default("pending") // "pending" | "push_sent" | "email_sent" | "completed" | "expired"
  createdAt     DateTime    @default(now()) @map("created_at")

  @@map("event_follow_ups")
  @@index([followUpAt, status])
  @@index([userId, status])
}

model StyleNarrative {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  narrative   String   @db.Text
  period      String   // "2026-W08"
  outfitCount Int      @map("outfit_count")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([userId, period])
  @@map("style_narratives")
  @@index([userId])
}

model MilestoneMessage {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestoneKey String   @map("milestone_key")
  message      String   @db.Text
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([userId, milestoneKey])
  @@map("milestone_messages")
  @@index([userId])
}

// ─── End Relationship System Models ──────────────────────────────────────────

model DailyMetricsSnapshot {
  id             String   @id @default(uuid())
  date           DateTime @unique @db.Date // The date this snapshot covers (UTC midnight)

  // Users
  totalUsers     Int      @map("total_users")
  newUsersToday  Int      @map("new_users_today")
  freeUsers      Int      @map("free_users")
  plusUsers      Int      @map("plus_users")
  proUsers       Int      @map("pro_users")

  // Engagement
  dau            Int      // Daily Active Users (checked outfit or gave feedback)
  wau            Int      // Weekly Active Users
  checksToday    Int      @map("checks_today")
  feedbacksToday Int      @map("feedbacks_today")
  avgAiScore     Float?   @map("avg_ai_score")

  // Streaks
  usersWithStreak Int     @map("users_with_streak")
  avgStreak       Float?  @map("avg_streak")

  // Revenue events (counts from subscription_events today)
  newSubscriptions   Int  @default(0) @map("new_subscriptions")
  cancellations      Int  @default(0)
  renewals           Int  @default(0)

  // Community
  comparisonPosts    Int  @default(0) @map("comparison_posts")
  liveSessions       Int  @default(0) @map("live_sessions")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("daily_metrics_snapshots")
}

model SubscriptionEvent {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventType      String   @map("event_type")
  productId      String?  @map("product_id")
  entitlementIds String[] @map("entitlement_ids")
  store          String?
  environment    String?

  rawPayload     Json?    @map("raw_payload")

  processedAt    DateTime @default(now()) @map("processed_at")

  @@map("subscription_events")
  @@index([userId, processedAt])
}

model WaitlistEntry {
  id           String   @id @default(uuid())
  email        String   @unique
  referralCode String   @unique @map("referral_code") // code others use to sign up via this person
  referredBy   String?  @map("referred_by")           // referralCode of the person who referred them
  position     Int      @default(0)                    // queue position (lower = earlier access)
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("waitlist_entries")
  @@index([createdAt])
}

// ─── Recursive AI Self-Improvement Models ─────────────────────────────────────

model DiscoveredRule {
  id             String   @id @default(uuid())
  category       String   // "color", "proportion", "occasion_matching", etc.
  rule           String   @db.Text
  confidence     Float
  sampleSize     Int      @map("sample_size")
  evidence       Json?
  incorporated   Boolean  @default(false)
  incorporatedIn String?  @map("incorporated_in")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("discovered_rules")
  @@index([category])
  @@index([incorporated])
}

model PromptVersion {
  id                String    @id @default(uuid())
  version           String    @unique
  parentVersion     String?   @map("parent_version")
  cohort            String?   @map("cohort") // C1: null = global, e.g. "minimalist-classic"
  promptText        String    @db.Text @map("prompt_text")
  source            String    @default("manual") // "manual", "auto-optimize"
  trafficPct        Int       @default(0) @map("traffic_pct")
  isActive          Boolean   @default(true) @map("is_active")
  isCandidate       Boolean   @default(false) @map("is_candidate")
  sampleSize        Int       @default(0) @map("sample_size")
  avgAiScore        Float?    @map("avg_ai_score")
  avgUserRating     Float?    @map("avg_user_rating")
  avgCommunityDelta Float?    @map("avg_community_delta")
  helpfulPct        Float?    @map("helpful_pct")
  promotedAt        DateTime? @map("promoted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  @@map("prompt_versions")
  @@index([isActive, trafficPct])
  @@index([parentVersion])
  @@index([cohort])
}

model ImprovementCycle {
  id                 String    @id @default(uuid())
  trigger            String    // "scheduled", "manual", "quality-drop"
  status             String    @default("running") // "running", "completed", "failed"
  log                String?   @db.Text
  triggerMetrics     Json?     @map("trigger_metrics")
  weaknessesFound    Json?     @map("weaknesses_found")
  knowledgeExtracted Json?     @map("knowledge_extracted")
  sourceVersion      String?   @map("source_version")
  candidateVersion   String?   @map("candidate_version")
  startedAt          DateTime  @default(now()) @map("started_at")
  completedAt        DateTime? @map("completed_at")

  @@map("improvement_cycles")
  @@index([status, startedAt])
}

// ─── End Recursive AI Self-Improvement Models ──────────────────────────────────

// ─── Self-Improving StyleDNA Engine Models ──────────────────────────────────

model IntelligenceBusEntry {
  id          String   @id @default(uuid())
  agent       String
  entryType   String   @map("entry_type")
  payload     Json
  consumedBy  String[] @default([]) @map("consumed_by")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("intelligence_bus_entries")
  @@index([entryType, createdAt])
  @@index([expiresAt])
}

model PromptSection {
  id             String    @id @default(uuid())
  sectionKey     String    @map("section_key")
  version        Int       @default(1)
  content        String    @db.Text
  isActive       Boolean   @default(true) @map("is_active")
  parentVersion  Int?      @map("parent_version")
  source         String    @default("manual")
  arenaWinRate   Float?    @map("arena_win_rate")
  changelog      String?
  failedAttempts Json      @default("[]") @map("failed_attempts")
  orderIndex     Int       @default(0) @map("order_index")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@unique([sectionKey, version])
  @@index([sectionKey, isActive])
  @@map("prompt_sections")
}

model LearningMemory {
  id             String   @id @default(uuid())
  compiledText   String   @db.Text @map("compiled_text")
  bulletCount    Int      @default(0) @map("bullet_count")
  sourceEntries  Int      @default(0) @map("source_entries")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("learning_memory")
}

model CritiqueReport {
  id              String   @id @default(uuid())
  weaknesses      Json     @default("[]")
  sectionMappings Json     @default("{}") @map("section_mappings")
  severityScores  Json     @default("{}") @map("severity_scores")
  addressed       Boolean  @default(false)
  piggybackPeriod String   @map("piggyback_period")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([addressed, createdAt])
  @@map("critique_reports")
}

model ArenaSession {
  id                    String   @id @default(uuid())
  challengerSectionKey  String   @map("challenger_section_key")
  challengerVersion     Int      @map("challenger_version")
  baselineVersion       Int      @map("baseline_version")
  trigger               String   @default("surgeon")
  status                String   @default("running")
  winRate               Float?   @map("win_rate")
  matchCount            Int      @default(0) @map("match_count")
  regressionPassed      Boolean? @map("regression_passed")
  deployed              Boolean  @default(false)
  resultSummary         String?  @map("result_summary")
  createdAt             DateTime @default(now()) @map("created_at")

  matches ArenaMatch[]

  @@map("arena_sessions")
}

model ArenaMatch {
  id                  String       @id @default(uuid())
  sessionId           String       @map("session_id")
  session             ArenaSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  scenarioType        String       @default("synthetic") @map("scenario_type")
  contextSnapshot     Json         @map("context_snapshot")
  baselineResponse    String       @db.Text @map("baseline_response")
  challengerResponse  String       @db.Text @map("challenger_response")
  winner              String
  scoreDelta          Json?        @map("score_delta")
  judgeRationale      String?      @db.Text @map("judge_rationale")
  createdAt           DateTime     @default(now()) @map("created_at")

  @@index([sessionId])
  @@map("arena_matches")
}

model RegressionCase {
  id              String   @id @default(uuid())
  scenarioName    String   @unique @map("scenario_name")
  contextSnapshot Json     @map("context_snapshot")
  baselineScores  Json     @map("baseline_scores")
  category        String
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("regression_cases")
}

model JudgeCalibration {
  id               String    @id @default(uuid())
  dimension        String    @unique
  biasOffset       Float     @default(0) @map("bias_offset")
  sampleSize       Int       @default(0) @map("sample_size")
  lastCalibratedAt DateTime? @map("last_calibrated_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@map("judge_calibrations")
}

model DailyTokenUsage {
  id             String   @id @default(uuid())
  date           String   @unique
  userTokens     Int      @default(0) @map("user_tokens")
  learningTokens Int      @default(0) @map("learning_tokens")
  reservedTokens Int      @default(0) @map("reserved_tokens")
  budget         Int
  learningBudget Int      @map("learning_budget")
  breakdown      Json     @default("{}") @map("breakdown")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("daily_token_usage")
}

// ─── End Self-Improving StyleDNA Engine Models ───────────────────────────────

// ─── Ops Learning Loop Models ────────────────────────────────────────────────

model EmailTemplateVariant {
  id          String   @id @default(uuid())
  sequence    String                        // "welcome", "reengagement", etc.
  step        Int                           // which step in the sequence
  field       String                        // "subject", "headline", "ctaText"
  variant     String   @db.Text            // the variant content
  isControl   Boolean  @default(false)     // is this the original?
  impressions Int      @default(0)
  opens       Int      @default(0)         // times opened (for subject variants)
  clicks      Int      @default(0)         // times clicked (for CTA variants)
  conversions Int      @default(0)         // outfit checks within 48h
  isWinner    Boolean? @map("is_winner")   // null=testing, true=promoted, false=retired
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([sequence, step, field, isControl])
  @@map("email_template_variants")
}

model NudgeVariant {
  id          String   @id @default(uuid())
  segment     String                       // "new_no_outfit", "inactive_3d", etc.
  title       String
  body        String
  isControl   Boolean  @default(false)
  impressions Int      @default(0)
  conversions Int      @default(0)        // outfit checks within 6h
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("nudge_variants")
  @@index([segment, isActive])
}

model SocialPromptVariant {
  id            String   @id @default(uuid())
  contentType   String   @unique @map("content_type") // "founder_story", etc.
  promptText    String   @db.Text @map("prompt_text")
  parentPrompt  String?  @db.Text @map("parent_prompt")
  avgEngagement Float?   @map("avg_engagement")
  sampleSize    Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("social_prompt_variants")
}

model ConversionCalibration {
  id             String   @id @default(uuid())
  signalType     String   @map("signal_type")
  strength       Float
  conversionRate Float    @map("conversion_rate")
  sampleSize     Int      @default(0) @map("sample_size")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("conversion_calibrations")
  @@index([signalType, isActive])
}

// ─── End Ops Learning Loop Models ────────────────────────────────────────────
